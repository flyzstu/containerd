name: Build Multi-Architecture Containerd

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]

env:
  GO_VERSION: '1.21'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - GOOS: linux
            GOARCH: amd64
            ARCH_SUFFIX: amd64
          - GOOS: linux
            GOARCH: arm64
            ARCH_SUFFIX: arm64
          - GOOS: linux
            GOARCH: s390x
            ARCH_SUFFIX: s390x
          - GOOS: linux
            GOARCH: ppc64le
            ARCH_SUFFIX: ppc64le

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get commit ID
      id: commit_info
      run: |
        echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "long_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      if: matrix.ARCH_SUFFIX != 'amd64'

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential pkg-config libseccomp-dev

    - name: Build containerd
      env:
        GOOS: ${{ matrix.GOOS }}
        GOARCH: ${{ matrix.GOARCH }}
        VERSION: ${{ steps.commit_info.outputs.short_sha }}
        REVISION: ${{ steps.commit_info.outputs.long_sha }}
        CGO_ENABLED: 0
        GODEBUG: x509ignoreCN=0
      run: |
        # Clean previous builds
        make clean

        # Build binaries
        make binaries

        # Verify binaries were created
        ls -la bin/

    - name: Create release package
      run: |
        PACKAGE_NAME="containerd-${{ steps.commit_info.outputs.short_sha }}-linux-${{ matrix.ARCH_SUFFIX }}"
        
        # Create package structure
        mkdir -p "$PACKAGE_NAME/bin"
        mkdir -p "$PACKAGE_NAME/etc/containerd"
        
        # Copy binaries
        cp bin/* "$PACKAGE_NAME/bin/"
        
        # Generate default config
        ./bin/containerd config default > "$PACKAGE_NAME/etc/containerd/config.toml"
        
        # Create tarball
        tar -czf "$PACKAGE_NAME.tar.gz" "$PACKAGE_NAME/"
        
        # Generate checksum
        sha256sum "$PACKAGE_NAME.tar.gz" > "$PACKAGE_NAME.tar.gz.sha256"
        
        # Display info
        echo "Created package: $PACKAGE_NAME.tar.gz"
        ls -la "$PACKAGE_NAME.tar.gz"*

    - name: Test binaries
      run: |
        # Test binary versions
        ./bin/ctr --version
        ./bin/containerd --version

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: containerd-${{ steps.commit_info.outputs.short_sha }}-linux-${{ matrix.ARCH_SUFFIX }}
        path: |
          containerd-${{ steps.commit_info.outputs.short_sha }}-linux-${{ matrix.ARCH_SUFFIX }}.tar.gz
          containerd-${{ steps.commit_info.outputs.short_sha }}-linux-${{ matrix.ARCH_SUFFIX }}.tar.gz.sha256
        retention-days: 30

  create-release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get commit ID
      id: commit_info
      run: |
        echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Move artifacts to root
      run: |
        find artifacts -name "*.tar.gz*" -exec mv {} . \;

    - name: Create release body
      run: |
        cat > release-body.md << 'EOF'
        # Containerd Multi-Architecture Build

        This release contains pre-built containerd binaries for multiple Linux architectures.

        ## Available Packages

        All packages include:
        - `bin/ctr` - Containerd CLI tool
        - `bin/containerd` - Containerd daemon
        - `bin/containerd-stress` - Stress testing tool
        - `etc/containerd/config.toml` - Default configuration

        ### Installation

        ```bash
        # Extract package
        tar -xzf containerd-{sha}-linux-{arch}.tar.gz
        
        # Install binaries
        sudo cp containerd-{sha}-linux-{arch}/bin/* /usr/local/bin/
        
        # Install config
        sudo mkdir -p /etc/containerd
        sudo cp containerd-{sha}-linux-{arch}/etc/containerd/config.toml /etc/containerd/
        ```

        ### Architectures Available
        EOF
        
        # Add available packages to release notes
        for pkg in containerd-*-linux-*.tar.gz; do
          echo "- \`$pkg\`" >> release-body.md
        done
        
        sed -i "s/{sha}/${{ steps.commit_info.outputs.short_sha }}/g" release-body.md

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release-body.md
        files: |
          containerd-*-linux-*.tar.gz
          containerd-*-linux-*.tar.gz.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}